# Cerberus CTF Platform - Hardened Redis 7 Configuration
# Location: /opt/cerberus/redis/redis.conf
# Description: Production-ready Redis with ACLs, TLS, and security hardening
# Target: Redis 7.x

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

# Bind to specific interfaces (localhost only by default, overridden in docker)
bind 0.0.0.0

# Protected mode - require explicit password or AUTH
protected-mode yes

# Listen port
port 6379

# TCP listen() backlog
# Increased for high-traffic CTF environment
tcp-backlog 65535

# TCP keepalive
tcp-keepalive 300

# Max clients (increased for CTF load)
maxclients 10000

# Disable TCP_NODELAY for better throughput with pipelining
tcp-nodelay no

# =============================================================================
# TLS/SSL CONFIGURATION
# =============================================================================

# Enable TLS
tls-port 6380
port 0

# TLS certificate files
tls-cert-file /certs/redis.crt
tls-key-file /certs/redis.key
tls-ca-cert-file /certs/ca.crt

# Protocols (disallow TLSv1.0 and TLSv1.1)
tls-protocols "TLSv1.2 TLSv1.3"

# TLS cipher configuration
tls-ciphers DEFAULT:!MEDIUM

# Require TLS for replication
tls-replication yes

# Require TLS for cluster bus
tls-cluster yes

# =============================================================================
# AUTHENTICATION
# =============================================================================

# Require password for connections (production: use strong password)
requirepass ${REDIS_PASSWORD}

# =============================================================================
# ACL CONFIGURATION (Redis 6.0+)
# =============================================================================

# Define users with specific permissions

# Default user - disabled (use named users)
user default on nopass ~* &* +@all

# Cerberus application user
# Permissions: All read operations, limited write operations for sessions/cache
user cerberus-app on >${REDIS_ACL_PASSWORD} ~cerberus:* &* 
    +@read
    +@write
    +@connection
    +@transaction
    +@scripting
    -DEBUG
    -CONFIG
    -FLUSHDB
    -FLUSHALL
    -KEYS
    -PEXPIRE
    -DEL
    -UNLINK
    +DEL|cerberus:*
    +UNLINK|cerberus:*
    +EXPIRE|cerberus:*
    +PEXPIRE|cerberus:*
    +EXPIREAT|cerberus:*
    +PEXPIREAT|cerberus:*

# Session management user (restricted)
user cerberus-session on >${REDIS_ACL_PASSWORD} ~session:* &* 
    +GET
    +SET
    +SETEX
    +EXPIRE
    +TTL
    +EXISTS
    +DEL
    +UNLINK
    +INCR
    +DECR
    +@connection
    +@transaction

# Cache management user (restricted)
user cerberus-cache on >${REDIS_ACL_PASSWORD} ~cache:* &* 
    +GET
    +SET
    +SETEX
    +MGET
    +MSET
    +EXPIRE
    +TTL
    +EXISTS
    +DEL
    +UNLINK
    +@connection
    +@transaction

# Rate limiting user (very restricted)
user cerberus-ratelimit on >${REDIS_ACL_PASSWORD} ~ratelimit:* &* 
    +INCR
    +EXPIRE
    +TTL
    +GET
    +SET
    +@connection

# Read-only user for monitoring
user cerberus-monitor on >${REDIS_ACL_PASSWORD} ~* &* 
    +@read
    +PING
    +ECHO
    +@connection
    -DEBUG
    -KEYS
    -SCAN

# Admin user (full access, separate strong password)
user cerberus-admin on >${REDIS_ADMIN_PASSWORD} ~* &* +@all

# =============================================================================
# PERSISTENCE (AOF)
# =============================================================================

# Enable AOF persistence
appendonly yes

# AOF file name
appendfilename "appendonly.aof"

# AOF sync policy - everysec for balance of performance/durability
appendfsync everysec

# Disable AOF fsync during rewrite
no-appendfsync-on-rewrite no

# AOF rewrite triggers
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Continue loading AOF even if it appears truncated
aof-load-truncated yes

# Use RDB preamble in AOF for faster rewrites
aof-use-rdb-preamble yes

# Disable RDB snapshots (using AOF exclusively)
save ""

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Max memory (2GB default, configurable via env)
maxmemory 2gb

# Eviction policy - LRU for cache behavior
maxmemory-policy allkeys-lru

# Max memory samples for LRU approximation
maxmemory-samples 5

# Replica ignore maxmemory
replica-ignore-maxmemory yes

# =============================================================================
# REPLICATION (Disabled for single-node setup)
# =============================================================================

# Replication settings commented out - enable for cluster setup
# replicaof <masterip> <masterport>
# masterauth <master-password>
# masteruser <master-username>

# =============================================================================
# CLUSTER (Disabled for single-node setup)
# =============================================================================

# Cluster mode disabled
cluster-enabled no

# =============================================================================
# SECURITY HARDENING
# =============================================================================

# Rename dangerous commands (disable by setting to empty string)
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""
rename-command DEBUG ""
rename-command SHUTDOWN ""

# Disable BGREWRITEAOF via rename
rename-command BGREWRITEAOF ""

# =============================================================================
# LOGGING
# =============================================================================

# Log level
loglevel notice

# Log file (stdout for Docker)
logfile ""

# Enable slow log
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 0

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Hash data structure optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List data structure optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set data structure optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Stream optimization
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================================================
# LATENCY MONITORING
# =============================================================================

# Enable latency monitoring
latency-tracking yes

# Latency tracking information percentiles
latency-tracking-info-percentiles 50 99 99.9

# =============================================================================
# IOTHREADS (Redis 6.0+)
# =============================================================================

# Enable IO threads for better performance on multi-core systems
io-threads 4

# Enable IO threads for reading (writing is always done in main thread)
io-threads-do-reads yes

# =============================================================================
# NOTIFICATIONS
# =============================================================================

# Disable keyspace notifications (enable if needed for cache invalidation)
notify-keyspace-events ""

# =============================================================================
# PROTOCOL
# =============================================================================

# Disable PROXY protocol
proxy-protocol-off

# Disable TCP keepalive on specific sockets
# tcp-keepalive 0

# =============================================================================
# MODULES (Load if needed)
# =============================================================================

# Load RedisSearch for advanced search capabilities (optional)
# loadmodule /usr/lib/redis/modules/redisearch.so

# Load RedisJSON for JSON support (optional)
# loadmodule /usr/lib/redis/modules/rejson.so

# Load RedisTimeSeries for metrics (optional)
# loadmodule /usr/lib/redis/modules/redistimeseries.so

# =============================================================================
# SNAPSHOTTING (BACKUP)
# =============================================================================

# Save points for RDB (disabled in favor of AOF)
# save 900 1
# save 300 10
# save 60 10000

# RDB compression
rdbcompression yes

# RDB checksum
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory
dir /data

# =============================================================================
# ADVANCED CONFIG
# =============================================================================

# Disable protected config commands
enable-protected-configs no

# Disable external module loading
enable-module-command no

# =============================================================================
# END OF CONFIGURATION
# =============================================================================
