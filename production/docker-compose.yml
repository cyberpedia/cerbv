version: "3.8"

# Cerberus CTF Platform - Production Docker Compose
# Single-node deployment with Traefik reverse proxy

services:
  # Traefik v3 - Reverse Proxy & Load Balancer
  traefik:
    image: traefik:v3.0
    container_name: cerb-traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"   # HTTP
      - "443:443" # HTTPS
      - "443:443/udp" # QUIC/HTTP3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yaml:/traefik/traefik.yaml:ro
      - ./traefik/dynamic.yaml:/traefik/dynamic.yaml:ro
      - traefik-certs:/letsencrypt
    environment:
      - TZ=UTC
    networks:
      - cerb-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"

  # Backend API - 3 replicas for zero-downtime
  backend:
    image: cerberus/backend:${BACKEND_VERSION:-latest}
    container_name: cerb-backend
    restart: unless-stopped
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    expose:
      - "8000"
    environment:
      - DATABASE_URL=postgresql://cerberus:${DB_PASSWORD}@postgres-primary:5432/cerberus
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=${SECRET_KEY}
      - DOMAIN=${DOMAIN:-localhost}
      - LOG_LEVEL=info
    depends_on:
      - postgres-primary
      - redis
    networks:
      - cerb-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cerb-backend.rule=Host(`api.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.cerb-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.cerb-backend.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.cerb-backend.loadbalancer.healthcheck.interval=10s"

  # Realtime Service - WebSocket handling
  realtime:
    image: cerberus/realtime:${REALTIME_VERSION:-latest}
    container_name: cerb-realtime
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    expose:
      - "3001"
    environment:
      - REDIS_URL=redis://redis:6379
      - DOMAIN=${DOMAIN:-localhost}
    depends_on:
      - redis
    networks:
      - cerb-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cerb-realtime.rule=Host(`realtime.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.cerb-realtime.tls.certresolver=letsencrypt"
      - "traefik.ws.cerb-realtime.enabled=true"

  # Frontend - Next.js standalone
  frontend:
    image: cerberus/frontend:${FRONTEND_VERSION:-latest}
    container_name: cerb-frontend
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - NEXT_PUBLIC_API_URL=https://api.${DOMAIN:-localhost}
      - NEXT_PUBLIC_WS_URL=wss://realtime.${DOMAIN:-localhost}
    depends_on:
      - backend
    networks:
      - cerb-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cerb-frontend.rule=Host(`${DOMAIN:-localhost}`) || Host(`www.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.cerb-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.cerb-frontend.loadbalancer.healthcheck.path=/"
      - "traefik.http.middlewares.cerb-frontend.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.cerb-frontend.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.cerb-frontend.headers.forceSTSHeader=true"

  # PostgreSQL Primary - Patroni for HA
  postgres-primary:
    image: cerberus/postgres:${POSTGRES_VERSION:-16}
    container_name: cerb-postgres-primary
    restart: unless-stopped
    environment:
      - POSTGRES_USER=cerberus
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=cerberus
      - PATRONI_SCOPE=cerberus-cluster
      - PATRONI_NAME=${HOSTNAME}
      - PATRONI_SUPERUSER_USERNAME=postgres
      - PATRONI_SUPERUSER_PASSWORD=${DB_PASSWORD}
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${DB_REPLICATION_PASSWORD}
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./postgres/patroni.yml:/patroni.yml:ro
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cerberus"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Replica - Read replicas for leaderboard queries
  postgres-replica:
    image: cerberus/postgres:${POSTGRES_VERSION:-16}
    container_name: cerb-postgres-replica
    restart: unless-stopped
    depends_on:
      - postgres-primary
    environment:
      - POSTGRES_USER=cerberus
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=cerberus
      - PATRONI_SCOPE=cerberus-cluster
      - PATRONI_SUPERUSER_USERNAME=postgres
      - PATRONI_SUPERUSER_PASSWORD=${DB_PASSWORD}
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${DB_REPLICATION_PASSWORD}
    volumes:
      - postgres-replica-data:/var/lib/postgresql/data
      - ./postgres/patroni.yml:/patroni.yml:ro
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"
    command: >
      patroni /patroni.yml

  # Redis - Sentinel mode for HA
  redis:
    image: redis:7-alpine
    container_name: cerb-redis
    restart: unless-stopped
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./redis/redis.conf:/etc/redis/redis.conf:ro
      - redis-data:/data
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Sentinel - For automatic failover
  redis-sentinel:
    image: redis:7-alpine
    container_name: cerb-redis-sentinel
    restart: unless-stopped
    command: redis-sentinel /etc/redis/sentinel.conf
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel.conf:ro
    networks:
      - cerb-network
    depends_on:
      - redis
    labels:
      - "traefik.enable=false"

  # MinIO - Distributed object storage
  minio:
    image: minio/minio:latest
    container_name: cerb-minio
    restart: unless-stopped
    command: server --console-address ":9001" http://minio{1...4}/data
    volumes:
      - minio-data{1...4}:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    networks:
      - cerb-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-console.rule=Host(`minio.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  # MinIO Server 2
  minio2:
    image: minio/minio:latest
    container_name: cerb-minio2
    restart: unless-stopped
    command: server --console-address ":9001" http://minio{1...4}/data
    volumes:
      - minio-data2:/data
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"

  # MinIO Server 3
  minio3:
    image: minio/minio:latest
    container_name: cerb-minio3
    restart: unless-stopped
    command: server --console-address ":9001" http://minio{1...4}/data
    volumes:
      - minio-data3:/data
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"

  # MinIO Server 4
  minio4:
    image: minio/minio:latest
    container_name: cerb-minio4
    restart: unless-stopped
    command: server --console-address ":9001" http://minio{1...4}/data
    volumes:
      - minio-data4:/data
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: cerb-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - cerb-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.prometheus.tls.certresolver=letsencrypt"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  # Grafana - Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: cerb-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - grafana-data:/var/lib/grafana
    networks:
      - cerb-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
    depends_on:
      - prometheus

  # Loki - Log aggregation
  loki:
    image: grafana/loki:latest
    container_name: cerb-loki
    restart: unless-stopped
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"

  # Promtail - Log shipping
  promtail:
    image: grafana/promtail:latest
    container_name: cerb-promtail
    restart: unless-stopped
    volumes:
      - ./monitoring/promtail.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - cerb-network
    depends_on:
      - loki
    labels:
      - "traefik.enable=false"

  # Alertmanager - Alert routing
  alertmanager:
    image: prom/alertmanager:latest
    container_name: cerb-alertmanager
    restart: unless-stopped
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    networks:
      - cerb-network
    labels:
      - "traefik.enable=false"

  # Backup Service - pgBackRest
  backup:
    image: cerberus/backup:${BACKUP_VERSION:-latest}
    container_name: cerb-backup
    restart: unless-stopped
    environment:
      - PGRST_API_TOKEN=${PGRST_API_TOKEN}
    volumes:
      - ./backup/pgbackrest.conf:/etc/pgbackrest/pgbackrest.conf:ro
      - ./backup/scripts:/scripts:ro
      - backup-data:/var/lib/pgbackrest
      - s3-backups:/s3
    networks:
      - cerb-network
    depends_on:
      - postgres-primary
    labels:
      - "traefik.enable=false"

volumes:
  # PostgreSQL
  postgres-primary-data:
    driver: local
  postgres-replica-data:
    driver: local
  
  # Redis
  redis-data:
    driver: local
  
  # MinIO distributed
  minio-data1:
  minio-data2:
  minio-data3:
  minio-data4:
  
  # Monitoring
  prometheus-data:
  grafana-data:
  loki-data:
  alertmanager-data:
  
  # Backups
  backup-data:
  s3-backups:
    driver: local
  
  # Traefik
  traefik-certs:

networks:
  cerb-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.0.0/24
